---
// ScheduleForm - Button-based date and time selection for scheduling
---

<section class="schedule-section">
  <div class="container schedule-container">
    <a href="/" class="logo-link">
      <img
        src="https://s3.qqeng.me/site/logotransparente.png"
        alt="Logo QQEnglish"
        class="logo"
        width="180"
        height="60"
      />
    </a>

    <h1 class="schedule-title">Agende sua Aula</h1>
    <p class="schedule-subtitle">
      Selecione a data e horario mais conveniente para sua aula experimental gratuita.
    </p>

    <!-- SVG templates for period icons (hidden, cloned by JS) -->
    <div id="svg-templates" style="display: none;">
      <svg id="icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg id="icon-sun-half" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
      </svg>
      <svg id="icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="loading-state">
      <div class="spinner"></div>
      <p>Carregando horarios disponiveis...</p>
    </div>

    <!-- Schedule Form -->
    <div id="schedule-form" class="schedule-form" style="display: none;">
      <div class="date-selector">
        <div class="selector-header">
          <div class="selector-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
          <div class="selector-text">
            <h3>Escolha uma data</h3>
            <p class="selector-hint" id="dates-count"></p>
          </div>
        </div>
        <div class="dates-grid" id="dates-grid"></div>
      </div>

      <div class="time-selector" id="time-selector-section" style="display: none;">
        <div class="selector-header">
          <div class="selector-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <div class="selector-text">
            <h3>Escolha um horario</h3>
            <p class="selector-hint" id="times-count">Selecione o melhor horario para voce</p>
          </div>
        </div>
        <div class="times-grid" id="times-grid"></div>
      </div>

      <div class="confirm-section">
        <div class="selected-summary" id="selected-summary" style="display: none;">
          <p>Voce selecionou:</p>
          <strong id="selected-datetime"></strong>
        </div>

        <label class="commitment-check" id="commitment-section" style="display: none;">
          <input type="checkbox" id="commitment-checkbox" />
          <span class="checkmark"></span>
          <span class="commitment-text">Confirmo meu compromisso em participar da aula no horario selecionado. Entendo que um professor sera reservado exclusivamente para mim.</span>
        </label>

        <button type="button" id="confirm-btn" class="confirm-button" disabled>
          <span id="confirm-btn-text">Confirmar Agendamento</span>
          <svg id="confirm-btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
          <div id="confirm-btn-spinner" class="spinner-small" style="display: none;"></div>
        </button>
      </div>

      <p id="error-message" class="error-message" style="display: none;"></p>
    </div>

    <!-- No Availability -->
    <div id="no-availability" class="no-availability" style="display: none;">
      <div class="no-availability-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="12"/>
          <line x1="12" y1="16" x2="12.01" y2="16"/>
        </svg>
      </div>
      <p>Nenhuma disponibilidade encontrada.</p>
      <p class="no-availability-hint">Por favor, valide o WhatsApp novamente.</p>
      <a href="/validacao" class="retry-link">Voltar para validacao</a>
    </div>
  </div>
</section>

<style>
  .schedule-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    background: linear-gradient(135deg, #f0f5fa 0%, #e8f4fd 100%);
  }

  .schedule-container {
    max-width: 640px;
    width: 100%;
    text-align: center;
    background: white;
    padding: 2rem 2.5rem;
    border-radius: var(--radius-lg, 1rem);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  }

  .logo-link {
    display: block;
    margin-bottom: 1.25rem;
  }

  .logo {
    max-width: 180px;
    height: auto;
    margin: 0 auto;
  }

  .schedule-title {
    font-size: 1.5rem;
    color: var(--color-dark, #1a1a2e);
    margin-bottom: 0.75rem;
    font-weight: 700;
  }

  .schedule-subtitle {
    font-size: 0.9375rem;
    color: var(--color-gray-600, #6b7280);
    margin-bottom: 1.25rem;
    line-height: 1.5;
  }

  /* Schedule Form */
  .schedule-form {
    text-align: left;
  }

  .date-selector,
  .time-selector {
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--color-gray-200, #e5e7eb);
  }

  .selector-header {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .selector-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(37, 99, 235, 0.1);
    color: var(--color-primary, #2563eb);
    border-radius: var(--radius-md, 0.5rem);
    flex-shrink: 0;
  }

  .selector-text h3 {
    font-size: 1.0625rem;
    font-weight: 700;
    margin-bottom: 0.125rem;
    color: var(--color-dark, #1a1a2e);
  }

  .selector-hint {
    font-size: 0.8125rem;
    color: var(--color-gray-500, #6b7280);
    margin: 0;
  }

  /* Dates wrapping grid */
  .dates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 0.5rem;
  }

  :global(.date-btn) {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 0.5rem;
    background: var(--color-primary, #2563eb);
    border: none;
    border-radius: var(--radius-md, 0.5rem);
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.2);
  }

  :global(.date-btn):hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    filter: brightness(1.1);
  }

  :global(.date-btn.selected) {
    background: var(--color-success, #10b981);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }

  :global(.day-label) {
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.125rem;
  }

  :global(.date-full) {
    font-size: 0.6875rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    white-space: nowrap;
  }

  /* Time buttons */
  .times-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  :global(.time-period) {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  :global(.period-label) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-gray-600, #6b7280);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  :global(.period-label) svg {
    color: var(--color-gray-400, #9ca3af);
  }

  :global(.period-times) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  :global(.time-btn) {
    padding: 0.625rem 1rem;
    min-width: 72px;
    background: var(--color-primary, #2563eb);
    border: none;
    border-radius: var(--radius-md, 0.5rem);
    font-size: 0.9375rem;
    font-weight: 600;
    color: white;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.2);
    transition: all 0.2s ease;
    text-align: center;
  }

  :global(.time-btn):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    filter: brightness(1.1);
  }

  :global(.time-btn.selected) {
    background: var(--color-success, #10b981);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    transform: scale(1.05);
  }

  /* Confirm section */
  .confirm-section {
    padding: 1.25rem 0 0;
    text-align: center;
  }

  .selected-summary {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: rgba(16, 185, 129, 0.08);
    border-radius: var(--radius-md, 0.5rem);
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .selected-summary p {
    font-size: 0.8125rem;
    color: var(--color-gray-600, #6b7280);
    margin-bottom: 0.25rem;
  }

  .selected-summary strong {
    font-size: 1rem;
    color: var(--color-dark, #1a1a2e);
  }

  .commitment-check {
    display: flex;
    align-items: flex-start;
    gap: 0.625rem;
    margin-bottom: 1rem;
    padding: 0.875rem;
    background: #fffbeb;
    border: 1px solid #fbbf24;
    border-radius: var(--radius-md, 0.5rem);
    cursor: pointer;
    text-align: left;
    user-select: none;
    -webkit-user-select: none;
  }

  .commitment-check input[type="checkbox"] {
    display: none;
  }

  .checkmark {
    width: 20px;
    height: 20px;
    min-width: 20px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    margin-top: 1px;
  }

  .commitment-check input:checked ~ .checkmark {
    background: var(--color-success, #10b981);
    border-color: var(--color-success, #10b981);
  }

  .commitment-check input:checked ~ .checkmark::after {
    content: '';
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    margin-bottom: 2px;
  }

  .commitment-text {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: #92400e;
  }

  .confirm-button {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem 1.5rem;
    font-size: 1.0625rem;
    font-weight: 600;
    color: white;
    background: var(--color-success, #10b981);
    border: none;
    border-radius: var(--radius-md, 0.5rem);
    cursor: pointer;
    transition: background 0.2s ease, transform 0.1s ease;
  }

  .confirm-button:hover:not(:disabled) {
    background: #0ea371;
  }

  .confirm-button:active:not(:disabled) {
    transform: scale(0.98);
  }

  .confirm-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .spinner-small {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  /* Error & loading */
  .error-message {
    color: var(--color-error, #ef4444);
    font-size: 0.875rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background: #fef2f2;
    border-radius: var(--radius-sm, 0.25rem);
    text-align: center;
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 2rem 0;
  }

  .loading-state p {
    color: var(--color-gray-600, #6b7280);
    margin-top: 1rem;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-gray-200, #e5e7eb);
    border-top-color: var(--color-success, #10b981);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .no-availability {
    padding: 2rem 0;
  }

  .no-availability-icon {
    color: var(--color-gray-400, #9ca3af);
    margin-bottom: 1rem;
  }

  .no-availability p {
    color: var(--color-gray-600, #6b7280);
    margin-bottom: 0.5rem;
  }

  .no-availability-hint {
    font-size: 0.875rem;
    color: var(--color-gray-500, #6b7280);
    margin-bottom: 1.5rem;
  }

  .retry-link {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: var(--color-primary, #2563eb);
    color: white;
    border-radius: var(--radius-md, 0.5rem);
    font-weight: 600;
    transition: background 0.2s ease;
    text-decoration: none;
  }

  .retry-link:hover {
    background: var(--color-primary-dark, #1d4ed8);
  }

  @media (max-width: 480px) {
    .schedule-section {
      padding: 1rem 0.5rem;
    }

    .schedule-container {
      padding: 1.5rem 1rem;
    }

    .schedule-title {
      font-size: 1.25rem;
    }

    .dates-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.375rem;
    }

    :global(.date-btn) {
      padding: 0.5rem 0.375rem;
    }

    :global(.time-btn) {
      min-width: 64px;
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
    }
  }
</style>

<script>
  interface TimeSlot {
    day: string;
    time: string;
    "room-schedule-id": number;
  }

  interface DisponibilidadeData {
    disponibilidade: TimeSlot[];
    student_id: string;
  }

  let disponibilidade: TimeSlot[] = [];
  let studentId: string = '';
  let selectedDate: string | null = null;
  let selectedSlot: TimeSlot | null = null;

  const loadingState = document.getElementById('loading-state') as HTMLDivElement;
  const scheduleForm = document.getElementById('schedule-form') as HTMLDivElement;
  const noAvailability = document.getElementById('no-availability') as HTMLDivElement;
  const errorMsg = document.getElementById('error-message') as HTMLParagraphElement;

  const weekdayNames: Record<number, string> = {
    0: 'Domingo', 1: 'Segunda', 2: 'Terca', 3: 'Quarta',
    4: 'Quinta', 5: 'Sexta', 6: 'Sabado'
  };

  const monthNames: Record<number, string> = {
    0: 'Janeiro', 1: 'Fevereiro', 2: 'Marco', 3: 'Abril',
    4: 'Maio', 5: 'Junho', 6: 'Julho', 7: 'Agosto',
    8: 'Setembro', 9: 'Outubro', 10: 'Novembro', 11: 'Dezembro'
  };

  function showError(message: string) {
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
  }

  function hideError() {
    errorMsg.style.display = 'none';
  }

  function parseDateStr(dateStr: string): Date {
    const [day, month, year] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day, 12, 0, 0);
  }

  function cloneIcon(iconId: string): Node | null {
    const template = document.getElementById(iconId);
    return template ? template.cloneNode(true) : null;
  }

  function loadDisponibilidade(): boolean {
    try {
      const storedData = sessionStorage.getItem('disponibilidade');
      if (!storedData) return false;

      const data: DisponibilidadeData = JSON.parse(storedData);
      if (!data.disponibilidade || !data.disponibilidade.length) return false;

      disponibilidade = data.disponibilidade;
      studentId = data.student_id;
      return true;
    } catch (error) {
      console.error('Error loading disponibilidade:', error);
      return false;
    }
  }

  function renderDates() {
    const datesGrid = document.getElementById('dates-grid')!;
    while (datesGrid.firstChild) {
      datesGrid.removeChild(datesGrid.firstChild);
    }

    const uniqueDates = [...new Set(disponibilidade.map(item => item.day))].sort((a, b) => {
      return parseDateStr(a).getTime() - parseDateStr(b).getTime();
    });

    const datesCount = document.getElementById('dates-count');
    if (datesCount) {
      datesCount.textContent = `${uniqueDates.length} datas disponiveis`;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    uniqueDates.forEach(dateStr => {
      const date = parseDateStr(dateStr);
      const dayOfWeek = date.getDay();
      const dayNum = date.getDate();
      const monthNum = date.getMonth();

      const diffDays = Math.floor((date.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
      let label = weekdayNames[dayOfWeek];
      if (diffDays === 0) label = 'Hoje';
      else if (diffDays === 1) label = 'Amanha';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'date-btn';
      btn.dataset.date = dateStr;

      const dayNameSpan = document.createElement('span');
      dayNameSpan.className = 'day-label';
      dayNameSpan.textContent = label;

      const dateSpan = document.createElement('span');
      dateSpan.className = 'date-full';
      dateSpan.textContent = `${dayNum} de ${monthNames[monthNum]}`;

      btn.appendChild(dayNameSpan);
      btn.appendChild(dateSpan);
      btn.addEventListener('click', () => selectDate(dateStr));
      datesGrid.appendChild(btn);
    });
  }

  function selectDate(dateStr: string) {
    selectedDate = dateStr;
    selectedSlot = null;

    document.querySelectorAll('.date-btn').forEach(btn => {
      btn.classList.toggle('selected', (btn as HTMLElement).dataset.date === dateStr);
    });

    renderTimes(dateStr);
    updateSummary();

    if (typeof window !== 'undefined' && (window as any).dataLayer) {
      const availableTimes = disponibilidade.filter(item => item.day === dateStr);
      (window as any).dataLayer.push({
        'event': 'schedule_date_selected',
        'selected_date': dateStr,
        'times_available': availableTimes.length
      });
    }
  }

  function renderTimes(dateStr: string) {
    const timesGrid = document.getElementById('times-grid')!;
    const timeSection = document.getElementById('time-selector-section')!;
    const timesCount = document.getElementById('times-count')!;

    while (timesGrid.firstChild) {
      timesGrid.removeChild(timesGrid.firstChild);
    }

    const availableTimes = disponibilidade
      .filter(item => item.day === dateStr)
      .sort((a, b) => a.time.localeCompare(b.time));

    timeSection.style.display = 'block';

    if (availableTimes.length === 0) {
      timesCount.textContent = 'Nenhum horario disponivel';
      return;
    }

    timesCount.textContent = `${availableTimes.length} horarios disponiveis`;

    const morning = availableTimes.filter(s => parseInt(s.time) < 12);
    const afternoon = availableTimes.filter(s => parseInt(s.time) >= 12 && parseInt(s.time) < 18);
    const evening = availableTimes.filter(s => parseInt(s.time) >= 18);

    function addPeriod(slots: TimeSlot[], periodName: string, iconId: string) {
      if (slots.length === 0) return;

      const periodDiv = document.createElement('div');
      periodDiv.className = 'time-period';

      const periodLabel = document.createElement('div');
      periodLabel.className = 'period-label';

      const icon = cloneIcon(iconId);
      if (icon) periodLabel.appendChild(icon);

      const nameSpan = document.createElement('span');
      nameSpan.textContent = periodName;
      periodLabel.appendChild(nameSpan);

      periodDiv.appendChild(periodLabel);

      const periodGrid = document.createElement('div');
      periodGrid.className = 'period-times';

      slots.forEach(slot => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'time-btn';
        btn.dataset.slot = JSON.stringify(slot);
        btn.textContent = slot.time;
        btn.addEventListener('click', () => selectTime(slot, btn));
        periodGrid.appendChild(btn);
      });

      periodDiv.appendChild(periodGrid);
      timesGrid.appendChild(periodDiv);
    }

    addPeriod(morning, 'Manha', 'icon-sun');
    addPeriod(afternoon, 'Tarde', 'icon-sun-half');
    addPeriod(evening, 'Noite', 'icon-moon');

    // Scroll time section into view
    timeSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function selectTime(slot: TimeSlot, clickedBtn: HTMLButtonElement) {
    selectedSlot = slot;

    document.querySelectorAll('.time-btn').forEach(btn => {
      btn.classList.remove('selected');
    });
    clickedBtn.classList.add('selected');

    updateSummary();

    if (typeof window !== 'undefined' && (window as any).dataLayer) {
      (window as any).dataLayer.push({
        'event': 'schedule_time_selected',
        'selected_time': slot.time,
        'selected_date': slot.day
      });
    }
  }

  function updateSummary() {
    const summary = document.getElementById('selected-summary')!;
    const datetime = document.getElementById('selected-datetime')!;
    const confirmBtn = document.getElementById('confirm-btn') as HTMLButtonElement;
    const commitmentSection = document.getElementById('commitment-section')!;
    const commitmentCheckbox = document.getElementById('commitment-checkbox') as HTMLInputElement;

    if (selectedDate && selectedSlot) {
      const date = parseDateStr(selectedDate);
      const weekday = weekdayNames[date.getDay()];
      const dayNum = date.getDate();
      const month = monthNames[date.getMonth()];

      datetime.textContent = `${weekday}, ${dayNum} de ${month} as ${selectedSlot.time}`;
      summary.style.display = 'block';
      commitmentSection.style.display = 'flex';
      confirmBtn.disabled = !commitmentCheckbox.checked;
    } else {
      summary.style.display = 'none';
      commitmentSection.style.display = 'none';
      confirmBtn.disabled = true;
    }
  }

  async function confirmSchedule() {
    if (!selectedSlot || !studentId) {
      showError('Por favor, selecione um horario.');
      return;
    }

    const confirmBtn = document.getElementById('confirm-btn') as HTMLButtonElement;
    const btnText = document.getElementById('confirm-btn-text')!;
    const btnIcon = document.getElementById('confirm-btn-icon')!;
    const btnSpinner = document.getElementById('confirm-btn-spinner')!;

    confirmBtn.disabled = true;
    btnText.textContent = 'Agendando...';
    btnIcon.style.display = 'none';
    btnSpinner.style.display = 'block';
    hideError();

    if (typeof window !== 'undefined' && (window as any).dataLayer) {
      (window as any).dataLayer.push({
        'event': 'schedule_confirm_attempt',
        'room_schedule_id': selectedSlot['room-schedule-id']
      });
    }

    try {
      const response = await fetch('https://w.qqeng.me/webhook/agendar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          'room-schedule-id': selectedSlot['room-schedule-id'],
          student_id: studentId,
          date: selectedSlot.day,
          time: selectedSlot.time
        })
      });

      const data = await response.json();

      if (data.success) {
        sessionStorage.removeItem('disponibilidade');

        if (typeof window !== 'undefined' && (window as any).dataLayer) {
          (window as any).dataLayer.push({
            'event': 'schedule_success',
            'scheduled_date': selectedSlot.day,
            'scheduled_time': selectedSlot.time
          });
          (window as any).dataLayer.push({
            'event': 'conversion',
            'conversion_type': 'schedule_complete',
            'value': 0,
            'currency': 'BRL'
          });
        }

        setTimeout(() => { window.location.href = '/sucesso'; }, 800);
      } else {
        throw new Error('Scheduling failed');
      }
    } catch (error) {
      console.error('Scheduling error:', error);
      showError('Erro ao realizar o agendamento. Por favor, tente novamente.');

      btnText.textContent = 'Confirmar Agendamento';
      btnIcon.style.display = 'block';
      btnSpinner.style.display = 'none';
      confirmBtn.disabled = false;

      if (typeof window !== 'undefined' && (window as any).dataLayer) {
        (window as any).dataLayer.push({
          'event': 'schedule_error',
          'error_type': 'api_error'
        });
      }
    }
  }

  // Event listeners
  document.getElementById('confirm-btn')?.addEventListener('click', confirmSchedule);
  document.getElementById('commitment-checkbox')?.addEventListener('change', () => {
    const confirmBtn = document.getElementById('confirm-btn') as HTMLButtonElement;
    const checkbox = document.getElementById('commitment-checkbox') as HTMLInputElement;
    if (selectedDate && selectedSlot) {
      confirmBtn.disabled = !checkbox.checked;
    }
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    const hasData = loadDisponibilidade();

    loadingState.style.display = 'none';

    if (hasData && disponibilidade.length > 0) {
      renderDates();
      scheduleForm.style.display = 'block';

      if (typeof window !== 'undefined' && (window as any).dataLayer) {
        (window as any).dataLayer.push({
          'event': 'page_view_schedule',
          'slots_available': disponibilidade.length,
          'dates_available': [...new Set(disponibilidade.map(i => i.day))].length
        });
      }
    } else {
      noAvailability.style.display = 'block';

      if (typeof window !== 'undefined' && (window as any).dataLayer) {
        (window as any).dataLayer.push({
          'event': 'page_view_schedule',
          'slots_available': 0,
          'error': 'no_data'
        });
      }
    }
  });
</script>
