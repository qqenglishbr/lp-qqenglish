---
// ValidationForm - WhatsApp code validation component
---

<section class="validation-section">
  <div class="container validation-container">
    <a href="/" class="logo-link">
      <img
        src="https://s3.qqeng.me/site/logotransparente.png"
        alt="Logo QQEnglish"
        class="logo"
        width="180"
        height="60"
      />
    </a>

    <h1 class="validation-title">Valide seu WhatsApp</h1>
    <p class="validation-subtitle">
      Enviamos um codigo para o seu WhatsApp. Insira o codigo abaixo para continuar.
    </p>

    <div id="loading-state" class="loading-state" style="display: none;">
      <p>Validando codigo...</p>
      <div class="spinner"></div>
    </div>

    <div id="form-state">
      <input
        type="text"
        id="validation-code"
        placeholder="Digite o codigo"
        class="code-input"
        maxlength="20"
        autocomplete="one-time-code"
        inputmode="text"
      />

      <button id="validate-btn" type="button" class="validate-button">
        Validar
      </button>

      <p id="error-message" class="error-message" style="display: none;"></p>
    </div>

    <p class="help-text">
      Nao recebeu o codigo? <a href="/" class="help-link">Voltar e tentar novamente</a>
    </p>
  </div>
</section>

<style>
  .validation-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    background: linear-gradient(135deg, #f0f5fa 0%, #e8f4fd 100%);
  }

  .validation-container {
    max-width: 420px;
    width: 100%;
    text-align: center;
    background: white;
    padding: 2.5rem;
    border-radius: var(--radius-lg, 1rem);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
  }

  .logo-link {
    display: block;
    margin-bottom: 2rem;
  }

  .logo {
    max-width: 180px;
    height: auto;
    margin: 0 auto;
  }

  .validation-title {
    font-size: 1.5rem;
    color: var(--color-dark, #1a1a2e);
    margin-bottom: 0.75rem;
    font-weight: 700;
  }

  .validation-subtitle {
    font-size: 1rem;
    color: var(--color-gray-600, #6b7280);
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .code-input {
    width: 100%;
    padding: 1rem;
    font-size: 1.25rem;
    text-align: center;
    letter-spacing: 0.15em;
    border: 2px solid var(--color-gray-300, #d1d5db);
    border-radius: var(--radius-md, 0.5rem);
    margin-bottom: 1rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    font-family: inherit;
  }

  .code-input:focus {
    outline: none;
    border-color: var(--color-primary, #2563eb);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .code-input::placeholder {
    letter-spacing: normal;
    color: var(--color-gray-400, #9ca3af);
  }

  .validate-button {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: white;
    background: var(--color-success, #10b981);
    border: none;
    border-radius: var(--radius-md, 0.5rem);
    cursor: pointer;
    transition: background 0.2s ease, transform 0.1s ease;
  }

  .validate-button:hover {
    background: #0ea371;
  }

  .validate-button:active {
    transform: scale(0.98);
  }

  .validate-button:disabled {
    background: var(--color-gray-400, #9ca3af);
    cursor: not-allowed;
    transform: none;
  }

  .error-message {
    color: var(--color-error, #ef4444);
    font-size: 0.875rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background: #fef2f2;
    border-radius: var(--radius-sm, 0.25rem);
  }

  .loading-state {
    text-align: center;
    padding: 2rem 0;
  }

  .loading-state p {
    color: var(--color-gray-600, #6b7280);
    margin-bottom: 1rem;
  }

  .spinner {
    width: 48px;
    height: 48px;
    margin: 0 auto;
    border: 4px solid var(--color-gray-200, #e5e7eb);
    border-top-color: var(--color-success, #10b981);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .help-text {
    margin-top: 1.5rem;
    font-size: 0.875rem;
    color: var(--color-gray-500, #6b7280);
  }

  .help-link {
    color: var(--color-primary, #2563eb);
    text-decoration: underline;
    font-weight: 500;
  }

  .help-link:hover {
    color: var(--color-primary-dark, #1d4ed8);
  }

  @media (max-width: 480px) {
    .validation-container {
      padding: 2rem 1.5rem;
    }

    .validation-title {
      font-size: 1.25rem;
    }

    .code-input {
      font-size: 1.125rem;
    }
  }
</style>

<script>
  const codeInput = document.getElementById('validation-code') as HTMLInputElement;
  const validateBtn = document.getElementById('validate-btn') as HTMLButtonElement;
  const errorMsg = document.getElementById('error-message') as HTMLParagraphElement;
  const loadingState = document.getElementById('loading-state') as HTMLDivElement;
  const formState = document.getElementById('form-state') as HTMLDivElement;

  function setLoading(isLoading: boolean) {
    loadingState.style.display = isLoading ? 'block' : 'none';
    formState.style.display = isLoading ? 'none' : 'block';
  }

  function showError(message: string) {
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
  }

  function hideError() {
    errorMsg.style.display = 'none';
  }

  async function validateCode() {
    const code = codeInput.value.trim();

    if (!code) {
      showError('Por favor, insira o codigo.');
      return;
    }

    setLoading(true);
    hideError();

    // Track validation attempt
    if (typeof window !== 'undefined' && (window as any).dataLayer) {
      (window as any).dataLayer.push({
        'event': 'validation_attempt',
        'validation_code_length': code.length
      });
    }

    try {
      const response = await fetch('https://w.qqeng.me/webhook/valida-whatsapp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      });

      const data = await response.json();

      if (data.validado) {
        // Store data for scheduling page
        sessionStorage.setItem('disponibilidade', JSON.stringify({
          disponibilidade: data.disponibilidade,
          student_id: data.student_id
        }));

        // Track successful validation
        if (typeof window !== 'undefined' && (window as any).dataLayer) {
          (window as any).dataLayer.push({
            'event': 'validation_success',
            'slots_available': data.disponibilidade?.length || 0
          });
        }

        // Redirect to scheduling
        window.location.href = '/agendamento';
      } else {
        showError('Codigo invalido. Por favor, tente novamente.');
        setLoading(false);

        // Track failed validation
        if (typeof window !== 'undefined' && (window as any).dataLayer) {
          (window as any).dataLayer.push({
            'event': 'validation_failed',
            'error_reason': 'invalid_code'
          });
        }
      }
    } catch (error) {
      console.error('Validation error:', error);
      showError('Erro ao validar o codigo. Por favor, tente novamente.');
      setLoading(false);

      if (typeof window !== 'undefined' && (window as any).dataLayer) {
        (window as any).dataLayer.push({
          'event': 'validation_error',
          'error_type': 'network'
        });
      }
    }
  }

  // Event listeners
  validateBtn?.addEventListener('click', validateCode);

  codeInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      validateCode();
    }
  });

  // Auto-validate if code is in URL
  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const urlCode = urlParams.get('code');

    if (urlCode) {
      codeInput.value = urlCode;
      validateCode();
    }

    // Track page view
    if (typeof window !== 'undefined' && (window as any).dataLayer) {
      (window as any).dataLayer.push({
        'event': 'page_view_validation',
        'has_url_code': !!urlCode
      });
    }
  });
</script>
