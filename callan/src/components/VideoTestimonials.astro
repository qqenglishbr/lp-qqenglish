---
// Unified Testimonials section - Comments carousel + Video testimonials
interface VideoTestimonial {
  videoId: string;
  name: string;
  title: string;
}

const videoTestimonials: VideoTestimonial[] = [
  { videoId: "I5hTNKwIsRo", name: "Rodrigo", title: "" },
  { videoId: "IT3ozsqXrKU", name: "Célia", title: "" },
  { videoId: "ZxTuUDJKtfs", name: "Paulo", title: "" }
];

const comments = [
  { id: 1, alt: "Ali Khodashenas from Iran - He is a very good teacher and has very good energy in the classroom" },
  { id: 3, alt: "Hiro from Japan - This was my first time using the Callan Method, and I enjoyed it" },
  { id: 5, alt: "Polyanna from Brazil - It's a good teacher!" },
  { id: 6, alt: "Wellington from Brazil - Rocky is an amazing teacher! I totally recommend her" },
  { id: 8, alt: "Seyedeh Maryam from Iran - Thank you so much indeed my dear teacher" },
  { id: 9, alt: "Cho Lucy from South Korea - She is a good teacher! She always makes me fun" },
  { id: 10, alt: "Seven Lee from South Korea - She is very kind and smart" },
  { id: 11, alt: "Alessio from Spain - Thank you! Alessio really likes you!" },
  { id: 12, alt: "Anna from Russia - We had nice time talking together!" },
  { id: 13, alt: "Olivia from Vietnam - Thank you my most favorite teacher" },
  { id: 14, alt: "Mikhail from Russia - I study at this school for 6 months. He is my favorite teacher!" },
  { id: 16, alt: "Natha from Thailand - Very good teacher but always full booking" },
  { id: 17, alt: "Paweena from Thailand - She's very kind and nice. She's good teacher" },
  { id: 18, alt: "Andy from China - You are very very good. You are the super teacher!" },
  { id: 20, alt: "Muugii from Mongolia - She is absolutely nice teacher" },
  { id: 21, alt: "Karmel from Philippines - The teacher started by checking whether the student can hear and see her well" },
];
---

<section class="testimonials" id="depoimentos">
  <div class="container">
    <!-- Section Header -->
    <div class="section-header reveal">
      <span class="section-eyebrow">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="2" y1="12" x2="22" y2="12"/>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
        </svg>
        Depoimentos
      </span>
      <h2 class="section-title">O que dizem nossos alunos</h2>
      <p class="section-subtitle">
        Depoimentos reais de estudantes de mais de 30 países
      </p>
    </div>

    <!-- Comments Carousel -->
    <div class="carousel-wrapper reveal">
      <button class="carousel-btn carousel-btn-prev" aria-label="Anterior" type="button">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>

      <div class="carousel-track-container">
        <div class="carousel-track">
          {comments.map((comment) => (
            <div class="carousel-slide">
              <img
                src={`/images/comments/comment-${comment.id}.jpg`}
                alt={comment.alt}
                loading="lazy"
                width="400"
                height="120"
              />
            </div>
          ))}
        </div>
      </div>

      <button class="carousel-btn carousel-btn-next" aria-label="Próximo" type="button">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>

    <!-- Carousel Dots -->
    <div class="carousel-dots"></div>

    <!-- Video Testimonials Subsection -->
    <div class="video-subsection reveal">
      <h3 class="subsection-title">Assista aos depoimentos</h3>
    </div>

    <!-- Videos Grid - Phone Frames -->
    <div class="phones-grid">
      {videoTestimonials.map((testimonial, index) => (
        <div class="phone-wrapper reveal" style={`--delay: ${index * 0.15}s`}>
          <div class="phone-frame">
            <div class="phone-notch"></div>
            <div class="phone-screen">
              <div class="youtube-facade" data-video-id={testimonial.videoId}>
                <img
                  src={`https://i.ytimg.com/vi/${testimonial.videoId}/hqdefault.jpg`}
                  alt={`Depoimento de ${testimonial.name}`}
                  loading="lazy"
                  class="youtube-thumbnail"
                />
                <button class="youtube-play" aria-label="Reproduzir vídeo">
                  <svg viewBox="0 0 68 48" width="68" height="48">
                    <path class="youtube-play-bg" d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#FF0000"/>
                    <path d="M 45,24 27,14 27,34" fill="#fff"/>
                  </svg>
                </button>
              </div>
            </div>
            <div class="phone-home-indicator"></div>
          </div>
          <div class="phone-info">
            <span class="phone-name">{testimonial.name}</span>
            {testimonial.title && <span class="phone-title">{testimonial.title}</span>}
          </div>
        </div>
      ))}
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar reveal">
      <div class="stat-item">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-number">+50.000</span>
          <span class="stat-label">alunos satisfeitos</span>
        </div>
      </div>

      <div class="stat-divider"></div>

      <div class="stat-item">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-number">15+</span>
          <span class="stat-label">anos de experiência</span>
        </div>
      </div>

      <div class="stat-divider"></div>

      <div class="stat-item">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="2" y1="12" x2="22" y2="12"/>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-number">30+</span>
          <span class="stat-label">países atendidos</span>
        </div>
      </div>

      <div class="stat-divider"></div>

      <div class="stat-item">
        <div class="stat-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
        </div>
        <div class="stat-content">
          <span class="stat-number">+1.300</span>
          <span class="stat-label">professores certificados</span>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .testimonials {
    padding: var(--section-padding) 0;
    background: var(--color-gray-50);
    overflow: hidden;
  }

  /* Section Header */
  .section-header {
    text-align: center;
    max-width: 640px;
    margin: 0 auto 3rem;
  }

  .section-eyebrow {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-body);
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }

  .section-eyebrow svg {
    opacity: 0.8;
  }

  .section-title {
    font-family: var(--font-display);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 700;
    color: var(--color-dark);
    line-height: 1.2;
    margin-bottom: 0.75rem;
  }

  .section-subtitle {
    font-size: 1.0625rem;
    color: var(--color-gray-600);
    line-height: 1.6;
  }

  /* Carousel */
  .carousel-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 1.25rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  .carousel-track-container {
    overflow: hidden;
    flex: 1;
    border-radius: var(--radius-lg);
  }

  .carousel-track {
    display: flex;
    gap: 1.25rem;
    transition: transform 0.5s var(--ease-out-expo);
  }

  .carousel-slide {
    flex: 0 0 calc(33.333% - 0.833rem);
    min-width: calc(33.333% - 0.833rem);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: all var(--transition-fast);
    background: white;
  }

  .carousel-slide:hover {
    transform: translateY(-4px);
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .carousel-slide img {
    width: 100%;
    height: auto;
    display: block;
  }

  .carousel-btn {
    flex-shrink: 0;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: 2px solid var(--color-gray-200);
    background: white;
    color: var(--color-gray-600);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    z-index: 10;
    box-shadow: var(--shadow-sm);
  }

  .carousel-btn:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 85, 204, 0.3);
  }

  .carousel-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
  }

  .carousel-dots .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--color-gray-300);
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    padding: 0;
  }

  .carousel-dots .dot.active {
    background: var(--color-primary);
    transform: scale(1.3);
  }

  .carousel-dots .dot:hover:not(.active) {
    background: var(--color-gray-400);
  }

  /* Video Subsection */
  .video-subsection {
    text-align: center;
    margin: 4rem 0 2rem;
  }

  .subsection-title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-dark);
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
  }

  .subsection-title::before,
  .subsection-title::after {
    content: '';
    width: 40px;
    height: 2px;
    background: var(--color-gray-300);
  }

  /* Phone Frames Grid */
  .phones-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 2rem;
    margin: 0 auto 3rem;
  }

  .phone-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .phone-frame {
    position: relative;
    width: 220px;
    height: 440px;
    background: linear-gradient(145deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
    border-radius: 36px;
    padding: 12px;
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.4),
      0 0 0 1px rgba(255, 255, 255, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transition: transform var(--transition-fast);
  }

  .phone-frame:hover {
    transform: translateY(-8px) scale(1.02);
  }

  .phone-notch {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 24px;
    background: #000;
    border-radius: 0 0 14px 14px;
    z-index: 10;
  }

  .phone-notch::before {
    content: '';
    position: absolute;
    top: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 8px;
    height: 8px;
    background: #1a1a1a;
    border-radius: 50%;
    box-shadow: inset 0 0 0 2px #333;
  }

  .phone-screen {
    position: relative;
    width: 100%;
    height: 100%;
    background: #000;
    border-radius: 24px;
    overflow: hidden;
  }

  .phone-screen iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  /* YouTube Facade - Lazy loading pattern */
  .youtube-facade {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .youtube-thumbnail {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: auto;
    height: 100%;
    min-width: 100%;
    object-fit: cover;
  }

  .youtube-play {
    position: relative;
    z-index: 2;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: transform 0.2s ease, filter 0.2s ease;
  }

  .youtube-play:hover {
    transform: scale(1.1);
    filter: brightness(1.1);
  }

  .youtube-facade.loaded {
    display: none;
  }

  .phone-home-indicator {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 4px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
    z-index: 10;
  }

  .phone-info {
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .phone-name {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-dark);
  }

  .phone-title {
    font-size: 0.875rem;
    color: var(--color-gray-500);
  }

  /* Stats Bar */
  .stats-bar {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    padding: 2rem;
    background: linear-gradient(135deg, var(--color-dark) 0%, #1a2744 100%);
    border-radius: var(--radius-xl);
  }

  @media (min-width: 768px) {
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2rem 3rem;
    }
  }

  .stat-item {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .stat-icon svg {
    width: 24px;
    height: 24px;
    color: var(--color-accent);
  }

  .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-number {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    line-height: 1.2;
  }

  .stat-label {
    font-size: 0.8125rem;
    color: rgba(255, 255, 255, 0.6);
  }

  .stat-divider {
    display: none;
    width: 1px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
  }

  @media (min-width: 768px) {
    .stat-divider {
      display: block;
    }
  }

  /* Reveal animation */
  .reveal {
    opacity: 0;
    transform: translateY(30px);
  }

  .section-header.reveal { --delay: 0s; }
  .carousel-wrapper.reveal { --delay: 0.15s; }
  .video-subsection.reveal { --delay: 0.2s; }
  .stats-bar.reveal { --delay: 0.3s; }

  .reveal.is-visible {
    animation: reveal 0.8s var(--ease-out-expo) forwards;
    animation-delay: var(--delay);
  }

  @keyframes reveal {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Tablet */
  @media (max-width: 1024px) {
    .carousel-slide {
      flex: 0 0 calc(50% - 0.625rem);
      min-width: calc(50% - 0.625rem);
    }
  }

  /* Mobile */
  @media (max-width: 768px) {
    .phones-grid {
      gap: 2.5rem;
    }

    .phone-frame {
      width: 200px;
      height: 400px;
    }
  }

  @media (max-width: 640px) {
    .carousel-slide {
      flex: 0 0 100%;
      min-width: 100%;
    }

    .carousel-btn {
      display: none;
    }

    .carousel-wrapper {
      gap: 0;
    }

    .carousel-track-container {
      scroll-snap-type: x mandatory;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .carousel-track-container::-webkit-scrollbar {
      display: none;
    }

    .carousel-track {
      transition: none;
    }

    .carousel-slide {
      scroll-snap-align: start;
    }
  }

  @media (max-width: 480px) {
    .phone-frame {
      width: 180px;
      height: 360px;
      border-radius: 30px;
      padding: 10px;
    }

    .phone-notch {
      width: 60px;
      height: 20px;
      top: 10px;
    }

    .phone-screen {
      border-radius: 20px;
    }

    .subsection-title::before,
    .subsection-title::after {
      width: 20px;
    }
  }
</style>

<script>
  class TestimonialsCarousel {
    private track: HTMLElement;
    private slides: HTMLElement[];
    private prevBtn: HTMLButtonElement;
    private nextBtn: HTMLButtonElement;
    private dotsContainer: HTMLElement;
    private currentIndex: number = 0;
    private slidesPerView: number = 3;
    private autoplayInterval: ReturnType<typeof setInterval> | null = null;

    constructor(section: HTMLElement) {
      this.track = section.querySelector('.carousel-track') as HTMLElement;
      this.slides = Array.from(section.querySelectorAll('.carousel-slide'));
      this.prevBtn = section.querySelector('.carousel-btn-prev') as HTMLButtonElement;
      this.nextBtn = section.querySelector('.carousel-btn-next') as HTMLButtonElement;
      this.dotsContainer = section.querySelector('.carousel-dots') as HTMLElement;

      this.init();
    }

    private init() {
      this.updateSlidesPerView();
      this.createDots();
      this.bindEvents();
      this.startAutoplay();
      this.updateCarousel();
    }

    private updateSlidesPerView() {
      if (window.innerWidth <= 640) {
        this.slidesPerView = 1;
      } else if (window.innerWidth <= 1024) {
        this.slidesPerView = 2;
      } else {
        this.slidesPerView = 3;
      }
    }

    private get maxIndex() {
      return Math.max(0, this.slides.length - this.slidesPerView);
    }

    private createDots() {
      this.dotsContainer.innerHTML = '';
      const numDots = Math.ceil(this.slides.length / this.slidesPerView);

      for (let i = 0; i < numDots; i++) {
        const dot = document.createElement('button');
        dot.className = 'dot';
        dot.setAttribute('aria-label', `Ir para grupo ${i + 1}`);
        dot.addEventListener('click', () => this.goToIndex(i * this.slidesPerView));
        this.dotsContainer.appendChild(dot);
      }
    }

    private bindEvents() {
      this.prevBtn.addEventListener('click', () => this.prev());
      this.nextBtn.addEventListener('click', () => this.next());

      this.track.addEventListener('mouseenter', () => this.stopAutoplay());
      this.track.addEventListener('mouseleave', () => this.startAutoplay());

      window.addEventListener('resize', () => {
        this.updateSlidesPerView();
        this.createDots();
        this.updateCarousel();
      });

      if (window.innerWidth <= 640) {
        this.track.parentElement?.addEventListener('scroll', () => {
          const container = this.track.parentElement as HTMLElement;
          const scrollLeft = container.scrollLeft;
          const slideWidth = this.slides[0].offsetWidth + 20;
          this.currentIndex = Math.round(scrollLeft / slideWidth);
          this.updateDots();
        });
      }
    }

    private startAutoplay() {
      this.stopAutoplay();
      this.autoplayInterval = setInterval(() => this.next(), 4000);
    }

    private stopAutoplay() {
      if (this.autoplayInterval) {
        clearInterval(this.autoplayInterval);
        this.autoplayInterval = null;
      }
    }

    private prev() {
      this.currentIndex = Math.max(0, this.currentIndex - this.slidesPerView);
      this.updateCarousel();
    }

    private next() {
      if (this.currentIndex >= this.maxIndex) {
        this.currentIndex = 0;
      } else {
        this.currentIndex = Math.min(this.maxIndex, this.currentIndex + this.slidesPerView);
      }
      this.updateCarousel();
    }

    private goToIndex(index: number) {
      this.currentIndex = Math.min(this.maxIndex, Math.max(0, index));
      this.updateCarousel();
    }

    private updateCarousel() {
      if (window.innerWidth > 640) {
        const slideWidth = this.slides[0].offsetWidth;
        const gap = 20;
        const offset = this.currentIndex * (slideWidth + gap);
        this.track.style.transform = `translateX(-${offset}px)`;
      }
      this.updateDots();
    }

    private updateDots() {
      const dots = this.dotsContainer.querySelectorAll('.dot');
      const activeDotIndex = Math.floor(this.currentIndex / this.slidesPerView);

      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === activeDotIndex);
      });
    }
  }

  // Initialize carousel
  document.addEventListener('DOMContentLoaded', () => {
    const section = document.querySelector('.testimonials') as HTMLElement;
    if (section) {
      new TestimonialsCarousel(section);
    }

    // YouTube facade - lazy load iframe on click
    document.querySelectorAll('.youtube-facade').forEach((facade) => {
      facade.addEventListener('click', function() {
        const videoId = (this as HTMLElement).dataset.videoId;
        if (!videoId) return;

        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
        iframe.setAttribute('allowfullscreen', '');
        iframe.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;border:none;';

        const parent = (this as HTMLElement).parentElement;
        if (parent) {
          parent.appendChild(iframe);
          (this as HTMLElement).classList.add('loaded');
        }
      });
    });
  });

  // Reveal animation observer
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
      }
    });
  }, observerOptions);

  document.querySelectorAll('.testimonials .reveal').forEach(el => {
    observer.observe(el);
  });
</script>
