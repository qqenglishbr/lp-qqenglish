---
// Cookie Consent Banner with GTM Consent Mode v2
// Elegant, non-intrusive design with full preference controls
---

<!-- Cookie Banner -->
<div id="cookie-banner" class="cookie-banner" role="dialog" aria-labelledby="cookie-title" aria-describedby="cookie-desc" aria-hidden="true">
  <div class="cookie-content">
    <div class="cookie-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="8" cy="9" r="1.5" fill="currentColor"/>
        <circle cx="15" cy="8" r="1" fill="currentColor"/>
        <circle cx="10" cy="14" r="1.5" fill="currentColor"/>
        <circle cx="16" cy="13" r="1" fill="currentColor"/>
        <circle cx="13" cy="17" r="0.75" fill="currentColor"/>
      </svg>
    </div>
    <div class="cookie-text">
      <h3 id="cookie-title" class="cookie-title">Sua privacidade importa</h3>
      <p id="cookie-desc" class="cookie-desc">
        Usamos cookies para melhorar sua experiência e personalizar conteúdo.
        <button type="button" class="cookie-link" id="open-preferences">Gerenciar preferências</button>
      </p>
    </div>
    <div class="cookie-actions">
      <button type="button" class="cookie-btn cookie-btn--secondary" id="reject-all">
        Recusar
      </button>
      <button type="button" class="cookie-btn cookie-btn--primary" id="accept-all">
        Aceitar todos
      </button>
    </div>
  </div>
</div>

<!-- Preferences Modal -->
<div id="cookie-modal" class="cookie-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true" aria-hidden="true">
  <div class="modal-backdrop" id="modal-backdrop"></div>
  <div class="modal-container">
    <div class="modal-header">
      <h2 id="modal-title" class="modal-title">Preferências de cookies</h2>
      <button type="button" class="modal-close" id="close-modal" aria-label="Fechar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <p class="modal-intro">
        Escolha quais categorias de cookies você permite. Cookies necessários são essenciais
        para o funcionamento do site e não podem ser desativados.
      </p>

      <!-- Necessary Cookies -->
      <div class="cookie-category">
        <div class="category-header">
          <div class="category-info">
            <div class="category-icon category-icon--necessary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                <polyline points="9 12 11 14 15 10"/>
              </svg>
            </div>
            <div>
              <h4 class="category-title">Necessários</h4>
              <p class="category-desc">Essenciais para navegação e segurança do site.</p>
            </div>
          </div>
          <div class="toggle-wrapper toggle-wrapper--disabled">
            <span class="toggle-label">Sempre ativo</span>
          </div>
        </div>
      </div>

      <!-- Analytics Cookies -->
      <div class="cookie-category">
        <div class="category-header">
          <div class="category-info">
            <div class="category-icon category-icon--analytics">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 21H4.6c-.56 0-.84 0-1.054-.109a1 1 0 0 1-.437-.437C3 20.24 3 19.96 3 19.4V3"/>
                <path d="M7 14l4-4 4 4 6-6"/>
              </svg>
            </div>
            <div>
              <h4 class="category-title">Analytics</h4>
              <p class="category-desc">Nos ajudam a entender como você usa o site para melhorá-lo.</p>
            </div>
          </div>
          <label class="toggle-wrapper">
            <input type="checkbox" id="analytics-toggle" class="toggle-input" checked />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- Marketing Cookies -->
      <div class="cookie-category">
        <div class="category-header">
          <div class="category-info">
            <div class="category-icon category-icon--marketing">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8V4H8"/>
                <rect x="4" y="4" width="16" height="16" rx="2"/>
                <path d="M4 12h4l2 6 4-10 2 4h4"/>
              </svg>
            </div>
            <div>
              <h4 class="category-title">Marketing</h4>
              <p class="category-desc">Permitem anúncios personalizados e medição de campanhas.</p>
            </div>
          </div>
          <label class="toggle-wrapper">
            <input type="checkbox" id="marketing-toggle" class="toggle-input" checked />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="cookie-btn cookie-btn--secondary" id="save-preferences">
        Salvar preferências
      </button>
      <button type="button" class="cookie-btn cookie-btn--primary" id="accept-all-modal">
        Aceitar todos
      </button>
    </div>
  </div>
</div>

<script is:inline>
(function() {
  const STORAGE_KEY = 'cookie_consent';
  const CONSENT_VERSION = '1.0';

  // GTM Consent Mode default (denied until user consents)
  function setDefaultConsent() {
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }

    gtag('consent', 'default', {
      'ad_storage': 'denied',
      'ad_user_data': 'denied',
      'ad_personalization': 'denied',
      'analytics_storage': 'granted',
      'functionality_storage': 'granted',
      'personalization_storage': 'denied',
      'security_storage': 'granted',
      'wait_for_update': 500
    });

    dataLayer.push({
      'event': 'consent_default',
      'consent_version': CONSENT_VERSION
    });
  }

  // Update GTM Consent
  function updateConsent(preferences) {
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }

    gtag('consent', 'update', {
      'ad_storage': preferences.marketing ? 'granted' : 'denied',
      'ad_user_data': preferences.marketing ? 'granted' : 'denied',
      'ad_personalization': preferences.marketing ? 'granted' : 'denied',
      'analytics_storage': preferences.analytics ? 'granted' : 'denied',
      'personalization_storage': preferences.marketing ? 'granted' : 'denied'
    });

    dataLayer.push({
      'event': 'consent_update',
      'consent_analytics': preferences.analytics,
      'consent_marketing': preferences.marketing,
      'consent_version': CONSENT_VERSION
    });
  }

  // Save preferences to localStorage
  function savePreferences(preferences) {
    const data = {
      ...preferences,
      version: CONSENT_VERSION,
      timestamp: new Date().toISOString()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    updateConsent(preferences);
    hideBanner();
    hideModal();
  }

  // Load saved preferences
  function loadPreferences() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        if (data.version === CONSENT_VERSION) {
          return data;
        }
      }
    } catch (e) {
      console.warn('Error loading cookie preferences:', e);
    }
    return null;
  }

  // UI Elements
  const banner = document.getElementById('cookie-banner');
  const modal = document.getElementById('cookie-modal');
  const modalBackdrop = document.getElementById('modal-backdrop');
  const analyticsToggle = document.getElementById('analytics-toggle');
  const marketingToggle = document.getElementById('marketing-toggle');

  function showBanner() {
    banner.setAttribute('aria-hidden', 'false');
    banner.classList.add('is-visible');
  }

  function hideBanner() {
    banner.classList.remove('is-visible');
    banner.classList.add('is-hiding');
    setTimeout(() => {
      banner.setAttribute('aria-hidden', 'true');
      banner.classList.remove('is-hiding');
    }, 300);
  }

  function showModal() {
    modal.setAttribute('aria-hidden', 'false');
    modal.classList.add('is-visible');
    document.body.style.overflow = 'hidden';
    // Focus first interactive element
    document.getElementById('close-modal').focus();
  }

  function hideModal() {
    modal.classList.remove('is-visible');
    modal.classList.add('is-hiding');
    document.body.style.overflow = '';
    setTimeout(() => {
      modal.setAttribute('aria-hidden', 'true');
      modal.classList.remove('is-hiding');
    }, 300);
  }

  function acceptAll() {
    savePreferences({ analytics: true, marketing: true });
    dataLayer.push({ 'event': 'consent_accept_all' });
  }

  function rejectAll() {
    savePreferences({ analytics: false, marketing: false });
    dataLayer.push({ 'event': 'consent_reject_all' });
  }

  function saveCurrentPreferences() {
    const preferences = {
      analytics: analyticsToggle.checked,
      marketing: marketingToggle.checked
    };
    savePreferences(preferences);
    dataLayer.push({
      'event': 'consent_custom',
      'consent_analytics': preferences.analytics,
      'consent_marketing': preferences.marketing
    });
  }

  // Event Listeners
  document.getElementById('accept-all').addEventListener('click', acceptAll);
  document.getElementById('accept-all-modal').addEventListener('click', acceptAll);
  document.getElementById('reject-all').addEventListener('click', rejectAll);
  document.getElementById('save-preferences').addEventListener('click', saveCurrentPreferences);
  document.getElementById('open-preferences').addEventListener('click', showModal);
  document.getElementById('close-modal').addEventListener('click', hideModal);
  modalBackdrop.addEventListener('click', hideModal);

  // Escape key closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('is-visible')) {
      hideModal();
    }
  });


  // TEMP: Force consent accepted to test performance (banner disabled)
  const FORCE_CONSENT = true;
  if (FORCE_CONSENT) {
    const preferences = { analytics: true, marketing: true };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        ...preferences,
        version: CONSENT_VERSION,
        timestamp: new Date().toISOString(),
        forced: true
      }));
    } catch (e) {}
    updateConsent(preferences);
    return;
  }

  // Initialize
  setDefaultConsent();

  const savedPreferences = loadPreferences();
  if (savedPreferences) {
    // User already consented, apply saved preferences
    updateConsent(savedPreferences);
    // Set toggles to saved state
    analyticsToggle.checked = savedPreferences.analytics;
    marketingToggle.checked = savedPreferences.marketing;
  } else {
    // First visit, show banner after short delay
    setTimeout(showBanner, 1500);
  }
})();
</script>

<style>
  /* TEMP: hide cookie UI while FORCE_CONSENT is enabled */
  .cookie-banner,
  .cookie-modal {
    display: none !important;
  }

  /* Banner */
  .cookie-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    padding: 1rem;
    pointer-events: none;
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 0.3s var(--ease-out-expo), transform 0.4s var(--ease-out-expo);
  }

  .cookie-banner.is-visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .cookie-banner.is-hiding {
    opacity: 0;
    transform: translateY(20px);
  }

  .cookie-content {
    max-width: 900px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 1.25rem 1.5rem;
    background: var(--color-dark);
    border-radius: var(--radius-lg);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.24), 0 0 0 1px rgba(255, 255, 255, 0.05);
  }

  .cookie-icon {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-accent) 0%, #ffd94d 100%);
    border-radius: var(--radius-md);
    color: var(--color-dark);
  }

  .cookie-icon svg {
    width: 24px;
    height: 24px;
  }

  .cookie-text {
    flex: 1;
    min-width: 0;
  }

  .cookie-title {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 600;
    color: white;
    margin-bottom: 0.25rem;
    line-height: 1.3;
  }

  .cookie-desc {
    font-size: 0.875rem;
    color: var(--color-gray-400);
    line-height: 1.5;
    margin: 0;
  }

  .cookie-link {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
    cursor: pointer;
    background: none;
    border: none;
    font: inherit;
    padding: 0;
    transition: color var(--transition-fast);
  }

  .cookie-link:hover {
    color: #ffd94d;
  }

  .cookie-actions {
    display: flex;
    gap: 0.625rem;
    flex-shrink: 0;
  }

  .cookie-btn {
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
  }

  .cookie-btn--primary {
    background: var(--color-primary);
    color: white;
    border: none;
  }

  .cookie-btn--primary:hover {
    background: var(--color-primary-light);
    transform: translateY(-1px);
  }

  .cookie-btn--secondary {
    background: transparent;
    color: var(--color-gray-300);
    border: 1px solid var(--color-gray-600);
  }

  .cookie-btn--secondary:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--color-gray-400);
    color: white;
  }

  /* Modal */
  .cookie-modal {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s var(--ease-out-expo), visibility 0.3s;
  }

  .cookie-modal.is-visible {
    opacity: 1;
    visibility: visible;
  }

  .cookie-modal.is-hiding {
    opacity: 0;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(10, 22, 40, 0.7);
    backdrop-filter: blur(4px);
  }

  .modal-container {
    position: relative;
    width: 100%;
    max-width: 540px;
    max-height: calc(100vh - 2rem);
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transform: scale(0.95) translateY(10px);
    transition: transform 0.3s var(--ease-out-expo);
  }

  .cookie-modal.is-visible .modal-container {
    transform: scale(1) translateY(0);
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 1.75rem;
    border-bottom: 1px solid var(--color-gray-100);
  }

  .modal-title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-dark);
    margin: 0;
  }

  .modal-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    color: var(--color-gray-500);
    transition: all var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--color-gray-100);
    color: var(--color-dark);
  }

  .modal-body {
    padding: 1.5rem 1.75rem;
    overflow-y: auto;
    flex: 1;
  }

  .modal-intro {
    font-size: 0.9375rem;
    color: var(--color-gray-600);
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  .cookie-category {
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-gray-100);
  }

  .cookie-category:last-child {
    border-bottom: none;
  }

  .category-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }

  .category-info {
    display: flex;
    gap: 0.875rem;
    flex: 1;
  }

  .category-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
  }

  .category-icon svg {
    width: 20px;
    height: 20px;
  }

  .category-icon--necessary {
    background: #dcfce7;
    color: #16a34a;
  }

  .category-icon--analytics {
    background: #e0e7ff;
    color: #4f46e5;
  }

  .category-icon--marketing {
    background: #fef3c7;
    color: #d97706;
  }

  .category-title {
    font-family: var(--font-display);
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-dark);
    margin-bottom: 0.25rem;
  }

  .category-desc {
    font-size: 0.8125rem;
    color: var(--color-gray-500);
    line-height: 1.5;
    margin: 0;
  }

  /* Toggle Switch */
  .toggle-wrapper {
    position: relative;
    flex-shrink: 0;
  }

  .toggle-wrapper--disabled .toggle-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-gray-400);
    text-transform: uppercase;
    letter-spacing: 0.02em;
    padding: 0.375rem 0.75rem;
    background: var(--color-gray-100);
    border-radius: var(--radius-sm);
  }

  .toggle-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    display: block;
    width: 48px;
    height: 28px;
    background: var(--color-gray-200);
    border-radius: 14px;
    cursor: pointer;
    transition: background var(--transition-fast);
    position: relative;
  }

  .toggle-slider::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    transition: transform var(--transition-fast);
  }

  .toggle-input:checked + .toggle-slider {
    background: var(--color-primary);
  }

  .toggle-input:checked + .toggle-slider::after {
    transform: translateX(20px);
  }

  .toggle-input:focus-visible + .toggle-slider {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .modal-footer {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    padding: 1.25rem 1.75rem;
    border-top: 1px solid var(--color-gray-100);
    background: var(--color-gray-50);
  }

  /* Mobile Responsive */
  @media (max-width: 640px) {
    .cookie-content {
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      gap: 1rem;
      padding: 1.25rem;
    }

    .cookie-icon {
      width: 40px;
      height: 40px;
    }

    .cookie-icon svg {
      width: 22px;
      height: 22px;
    }

    .cookie-actions {
      width: 100%;
    }

    .cookie-btn {
      flex: 1;
      justify-content: center;
    }

    .modal-container {
      max-height: calc(100vh - 1rem);
      margin: 0.5rem;
    }

    .category-header {
      flex-direction: column;
      gap: 0.75rem;
    }

    .toggle-wrapper {
      align-self: flex-start;
      margin-left: 52px;
    }

    .modal-footer {
      flex-direction: column-reverse;
    }

    .modal-footer .cookie-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
